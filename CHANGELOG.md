# CHANGELOG

## [Unreleased] - 2025-12-13

### Added
- **デバッグモード**: 開発効率化のための診断ツール
  - デバッグパネル: ゲーム状態の可視化（連鎖数、アニメーション状態、選択位置）
  - 特殊タイル手動生成: 選択したタイルに任意の特殊タイプを適用
  - 障害物手動配置: 凍結、鎖、壊せるブロックを配置可能
  - トグルボタンでON/OFF切り替え（虫アイコン 🐛）

- **障害物システム**: ステージ戦略性を拡張
  - **壊せるブロック**: HP制（HP1〜3）、マッチでHP減少、0で破壊
    - 視覚表示: 茶色オーバーレイ + キューブアイコン + HP表示
  - **凍結タイル**: スワップ不可、1回のマッチで解除
    - 視覚表示: シアンオーバーレイ + 雪の結晶アイコン ❄️
  - **鎖タイル**: スワップ不可、1回のマッチで解除
    - 視覚表示: グレーオーバーレイ + 鍵アイコン 🔒
  - **穴**: タイル配置不可（将来の拡張用）
    - 視覚表示: 黒背景

### Changed
- **タイルデータ構造**: `Tile(type, special, obstacle)`に拡張
  - 通常タイル + 特殊タイプ + 障害物の複合構造
- **スワップロジック**: 凍結・鎖タイルのスワップをブロック
- **マッチ処理フロー**: 障害物処理を追加
  - マッチ検出 → 障害物処理 → 特殊タイル生成 → タイル消去 → 落下 → 補充

### Fixed
- **特殊タイル視認性**: 生成直後に消去される問題を修正
  - 特殊タイル生成位置をマッチ除外リストに追加
- **特殊タイルアイコン**: より目立つデザインに改善
  - 背景円を追加（黒い半透明円、レインボーはグラデーション）
  - アイコンサイズ拡大（0.4x → 0.5x）
  - バウンスアニメーション追加（0.3 → 1.1 → 1.0）

### Technical Details
- `ObstacleType` enum追加: none, breakable(hp), frozen, chained, hole
- `Tile.obstacle` プロパティ追加: 障害物状態を保持
- `processObstacles(at:)`: 障害物破壊・解除処理関数
- `debugMode` フラグ追加: デバッグ機能の有効/無効制御
- `debugCreateSpecialTile(at:, type:)`: デバッグ用特殊タイル生成
- `debugSetObstacle(at:, obstacle:)`: デバッグ用障害物配置
- `DebugPanel`: デバッグUIコンポーネント
- `ObstacleOverlay`: 障害物視覚表示コンポーネント

---

## [2025-12-12] - Special Tiles and Chain System

### Added
- **特殊タイルシステム**: パズルゲームに戦略性を追加
  - **ライン爆弾（横）**: 4個横消しで生成、横一列を消去
  - **ライン爆弾（縦）**: 4個縦消しで生成、縦一列を消去
  - **爆弾**: L字/T字パターンで生成、周囲3×3を消去
  - **レインボータイル**: 5個直線消しで生成、任意のタイルと交換すると同色タイルを全て消去
- **連鎖システム**: 連続マッチによるスコア倍率
  - 1連鎖: 1.0倍（基本）
  - 2連鎖: 1.2倍
  - 3連鎖: 1.5倍
  - 4連鎖: 2.0倍
  - 5連鎖: 2.5倍
  - 6連鎖以上: 3.0倍
- **連鎖ポップアップ**: 2連鎖以上で連鎖数と倍率を表示
- **特殊タイルビジュアル**: 各特殊タイルに専用アイコン表示
  - 横ライン: 左右矢印アイコン
  - 縦ライン: 上下矢印アイコン
  - 爆弾: 爆発アイコン
  - レインボー: 星アイコン

### Changed
- **タイルデータ構造**: `TileType`から`Tile(type, special)`構造に拡張
  - 通常タイルの色情報と特殊タイプを分離
- **マッチ検出ロジック**: 特殊パターン検出を追加
  - L/T字形状の検出
  - 4個/5個直線マッチの判定
- **スワップ処理**: レインボータイルの特殊交換に対応
  - レインボー + 通常タイル → 同色タイル全消去
- **マッチ処理フロー**: 特殊タイル生成タイミングを最適化
  - パターン検出 → タイル消去 → 特殊タイル生成 → 落下 → 補充

### Technical Details
- `SpecialType` enum追加: none, horizontalLine, verticalLine, bomb, rainbow
- `Tile` struct追加: type + special の構造
- `findSpecialPatterns(_ matches:)`: 特殊パターン検出関数
- `isLOrTShape(_ pos:, in matches:)`: L/T字判定関数
- `activateSpecialTile(at:)`: 特殊タイル効果発動関数
- `createSpecialTiles(_ specialPatterns:)`: 特殊タイル生成関数
- `ChainPopupView`: 連鎖ポップアップUI
- `SpecialTileOverlay`: 特殊タイルアイコン表示UI

---

## [2025-12-11] - Stage Selection System

### Added
- **ステージ選択機能**: 5つの難易度別ステージを追加
  - Stage 1 (初級): 目標1000点、10手
  - Stage 2 (中級): 目標2000点、8手
  - Stage 3 (上級): 目標3000点、7手
  - Stage 4 (超級): 目標4000点、6手
  - Stage 5 (極級): 目標5000点、5手
- **ステージアンロックシステム**: クリアすると次のステージがアンロック
- **ステージ選択画面**: ロック/アンロック状態を視覚的に表示
- **ステージ情報表示**: ゲーム画面にステージ番号と名前を表示
- **次のステージボタン**: クリア時に次のステージへ進めるボタンを追加
- **ステージ選択ボタン**: ゲーム中にステージ選択画面に戻れる機能

### Changed
- **ゲームフロー**: タイトル → ステージ選択 → ゲーム → クリア/ゲームオーバー
- **GameModel**: ステージ設定を受け取れるように変更
  - `init(stage: Stage?)` でステージ情報を初期化
  - `targetScore`と`maxMoves`をステージに応じて設定
- **ゲームオーバー画面**: 4つのボタンオプションに拡張
  - Next Stage (クリア時のみ、次のステージがある場合)
  - Play Again / Retry
  - Stage Select
  - Back to Title

---

## [2025-12-11] - Game State Check Fix

### Fixed
- **ゲーム状態チェックのタイミング修正**: スコア更新後に判定を実行
  - 最終手で目標スコアに到達した場合、正しくクリアになるように修正
  - 手数が0でもスコアが目標以上ならクリア判定

---

## [2025-12-11] - Max Moves Update

### Changed
- **最大手数を5に変更**: より難易度の高いゲームバランスに調整
- **手数警告の閾値を調整**: 残り2手以下で赤色表示

---

## [2025-12-11] - Title Screen

### Added
- **タイトル画面**: ゲーム起動時に表示
  - ゲームタイトル「マッチ3パズル」「Match 3 Puzzle」
  - ゲームルールと目標の説明
  - アニメーション付きSTARTボタン
- **画面遷移システム**: タイトル ⇄ ゲーム画面
- **戻るボタン**: ゲーム画面とゲームオーバー画面からタイトルに戻る機能

---

## [2025-12-11] - Immediate Clear/Game Over Display

### Fixed
- **即座のクリア/ゲームオーバー表示**: 条件達成時に即座に画面を表示
  - スコア更新直後にゲーム状態をチェック
  - アニメーション中でもゲーム終了時は処理を中断

---

## [2025-12-11] - Score and Moves Display Fix

### Fixed
- **スコアと手数の表示修正**:
  - 文字列補間を`String(value)`形式に変更
  - テキスト色を明示的に指定
  - `movesLeft`の初期化タイミングを修正
  - UIの更新を`DispatchQueue.main.async`で実行

---

## [2025-12-11] - Animation and Visual Effects

### Added
- **タイルスワップアニメーション**: 0.3秒のスワップ動作
- **マッチハイライト**: 黄色枠と白いオーバーレイで強調表示
- **タイル消去エフェクト**: フェードアウトとパーティクル効果
- **連鎖アニメーション**: マッチ → 消去 → 落下 → 補充の流れを視覚化

### Changed
- **アニメーションシーケンス**: スワップ(0.3s) → ハイライト(0.5s) → 消去(0.3s) → 落下(0.2s) → 補充(0.2s) → 連鎖チェック(0.4s)

---

## [2025-12-11] - Game Logic Fix

### Fixed
- **ゲームロジックの修正**:
  - タイルデータ構造を`[[TileType?]]`に変更（空のマスを表現）
  - マッチ検出ロジックを改善（nil対応）
  - タイル消去処理を修正（nilに設定）
  - 重力処理を修正（列ごとに下に詰める）
  - 補充処理を修正（nilのマスのみ補充）
- **スコア計算の修正**: タイル数 × 100点

---

## [2025-12-11] - Match3 Game Implementation

### Added
- **Match3パズルゲームの実装**:
  - 8×8グリッド盤面
  - 5種類のカラータイル（赤、青、緑、黄、紫）
  - タイルスワップ機能
  - マッチ検出（3個以上の縦横揃い）
  - タイル消去、落下、補充システム
  - スコアシステム
  - 手数制限（20手）
  - 目標スコア（3000点）
  - ゲームオーバー/クリア判定
- **UI実装**:
  - ゲームボード表示
  - スコア、目標、手数の表示
  - タイル選択の視覚フィードバック
  - ゲームオーバー画面

---

## [2025-12-11] - Initial Setup

### Added
- **Swift Playgrounds対応プロジェクト作成**:
  - Package.swift（Swift 5.5、iOS 15.2対応）
  - MyApp.swift（アプリエントリーポイント）
  - ContentView.swift（メインビュー）
- **基本設定**:
  - AppleProductTypes インポート
  - Bundle identifier設定
  - iPad/iPhone対応
